---
---
---

# Part 2: SQL

```{r}
library(tidyverse)
library(odbc)
library(DBI)
library(RSQLite)
library(sqldf)
```

```{r}
# read in dataset
df <- readr::read_csv("Healthcare Dataset.csv")
```

```{r}
# create a database
con <- dbConnect(RSQLite::SQLite(), ":memory:")
copy_to(con, df)
```

1.  Write a query to retrieve all rows for patients diagnosed with "Diabetes" fromÂ  the healthcare dataset on canvas.

```{r}
dbGetQuery(con, "SELECT * 
                 FROM df
                 WHERE [Medical Condition] = 'Diabetes'")
```

2.  List the names and Discharge Dates of all patients who were discharged after January 1, 2024, from the healthcare dataset.

```{r}
library(lubridate)

df$`Discharge Date` <- as.character(df$`Discharge Date`)
df$`Discharge Date` <- mdy(df$`Discharge Date`)  
df$`Discharge Date` <- format(df$`Discharge Date`, "%Y-%m-%d")
```

```{r}
copy_to(con, df, name = "df", overwrite = TRUE, temporary = FALSE)
```

```{r}
dbGetQuery(con, "
  SELECT patient, [Discharge Date]
  FROM df
  WHERE [Discharge Date] > '2024-01-01'
")
```

3.  How would you count the number of patients diagnosed with "Hypertension" in the healthcare dataset?

```{r}
dbGetQuery(con, "
  SELECT COUNT(*) AS hypertension_count
  FROM df
  WHERE [Medical Condition] = 'Hypertension'
")
```

4.  Write a query to show the total number of admissions for each hospital in the healthcare dataset.

```{r}
dbGetQuery(con, "
  SELECT Hospital, COUNT(*) AS total_admissions
  FROM df
  GROUP BY Hospital
  ORDER BY total_admissions DESC
")
```

5.  Calculate the total bill amount generated by each hospital using the bills with columns Hospital and Billing Amount from the healthcare dataset.

```{r}
dbGetQuery(con, "
  SELECT Hospital, SUM([Billing Amount]) AS total_billing
  FROM df
  GROUP BY Hospital
  ORDER BY total_billing DESC
")
```

6.  Combine the patient and Admission Type to list each patient's name alongside their Admission Date.

```{r}
dbGetQuery(con, "
  SELECT patient, [Admission Type], [Date of Admission]
  FROM df
")
```

7.  Retrieve all records for patients over 65 years old who were admitted for "Pneumonia" from the healthcare dataset.

```{r}
dbGetQuery(con, "
  SELECT *
  FROM df
  WHERE Age > 65 AND [Medical Condition] = 'Pneumonia'
")
```

```{r}
unique(df$`Medical Condition`) # pnuemonia isn't in the data at all
```

8.  Write a query to list all hospitals ordered by the total number of patients treated, in descending order for the healthcare dataset. (Hint: This involves sorting by hospital obtaining total number of patients treated at each hospital and sorting in descending order)

```{r}
dbGetQuery(con, "
  SELECT Hospital, COUNT(*) AS total_patients
  FROM df
  GROUP BY Hospital
  ORDER BY total_patients DESC
")
```

9.  Find the average length of stay for patients in the healthcare dataset (assume columns Date of Admission and Discharge Date).

```{r}
df$`Date of Admission` <- mdy(df$`Date of Admission`)  
df$`Date of Admission` <- format(df$`Date of Admission`, "%Y-%m-%d")
df$`Date of Admission` <- as.Date(df$`Date of Admission`)
df$`Discharge Date` <- as.Date(df$`Discharge Date`)

# Subtract to get length of stay
df$length_of_stay <- as.numeric(df$`Discharge Date` - df$`Date of Admission`)
```

```{r}
copy_to(con, df, name = "df", overwrite = TRUE, temporary = FALSE)

dbGetQuery(con, "
  SELECT AVG(length_of_stay) AS avg_length_of_stay
  FROM df
")
```

10. Write a query to find all patients whose Blood Type is A+ from the healthcare dataset.

```{r}
dbGetQuery(con, "
  SELECT *
  FROM df
  WHERE [Blood Type] = 'A+'
")
```
